# Trading Exchange Engine - MVP Phase 2 체크리스트

## 0. 범위 고정

> MVP Phase 2에서 구현하는 범위를 명확히 제한한다.

- 다종목 지원: BTC, ETH, TEST (yml 고정, 최대 20개 이하 전제)
- 주문 타입: LIMIT + MARKET
- 심볼별 독립 EngineLoop (Thread-per-symbol)
- 영속성은 in-memory 유지 (DB / 메시징 / WebSocket 미구현)
- 계좌 잔고 검증 없음
- 런타임 심볼 추가 없음

---

## 1. 도메인 확장

### 1.1 Symbol (Value Object)

| 불변식        | 규칙               |
| ---------- | ---------------- |
| null 불가    | null 전달 시 예외     |
| 대문자 고정     | 소문자 입력 시 예외 또는 변환 |

- [x] `Symbol` VO 구현 (value 필드, null 불가, 대문자 고정)
- [x] 동등성 비교 (`equals` / `hashCode`) 구현

### 1.2 OrderType (Enum)

- [x] `OrderType` 추가: `LIMIT`, `MARKET`
- [x] `isMarket()` 편의 메서드 구현

### 1.3 Order 확장

기존 `Order`에 `symbol`, `orderType` 필드 추가.
생성 경로를 팩토리 메서드로 분리하고, price는 `@Nullable`로 변경.

| 불변식                           | 규칙                                   |
| ----------------------------- | ------------------------------------ |
| LIMIT — price 필수              | `createLimit()` 호출 시 price null이면 예외 |
| MARKET — price 금지             | `createMarket()` 호출 시 price 전달하면 예외  |
| `getLimitPriceOrThrow()`      | MARKET에서 호출 시 예외                     |
| OrderBook에는 LIMIT만 저장         | MARKET은 절대 `orderBook.add()` 금지      |

- [x] `Order.createLimit(side, symbol, price, quantity)` 팩토리 메서드 구현
- [x] `Order.createMarket(side, symbol, quantity)` 팩토리 메서드 구현
- [x] 기존 생성자 private/package-private으로 제한
- [x] `price` 필드 `@Nullable` 선언, public `getPrice()` 제거 또는 LIMIT 전용 명시
- [x] `getLimitPriceOrThrow()` 구현 — MARKET 호출 시 예외
- [x] `isMarket()` 편의 메서드 구현
- [x] `symbol` 필드 추가
- [x] `orderType` 필드 추가

---

## 2. EngineManager / EngineContext 구현

### 2.1 EngineContext (심볼별 엔진 묶음)

```plaintext
EngineContext
 ├─ BlockingQueue<EngineCommand>
 ├─ EngineLoop
 ├─ EngineHandler
 ├─ MatchingEngine
 └─ OrderBook
```

- [ ] `EngineContext` 구조 정의 (심볼별 독립 인스턴스)
- [ ] `EngineContext` 생성 시 `BlockingQueue`, `OrderBook` 신규 생성
- [ ] `MatchingEngine`, `EngineHandler`, `EngineLoop`에서 `@Component` 제거

### 2.2 EngineManager

- [ ] `EngineManager` `@Component` 등록
- [ ] `application.yml`에서 심볼 목록 주입 (`@ConfigurationProperties` 또는 `@Value`)
- [ ] `@PostConstruct`에서 심볼별 `EngineContext` 생성 및 `EngineLoop` 시작
- [ ] `@PreDestroy`에서 모든 `EngineLoop` 순차 종료
- [ ] symbol → EngineContext 라우팅 (`Map<Symbol, EngineContext>`)
- [ ] 지원하지 않는 심볼 요청 시 예외 처리

### 2.3 심볼 등록 설정

```yaml
trading:
  symbols:
    - BTC
    - ETH
    - TEST
```

- [ ] `application.yml`에 심볼 목록 추가
- [ ] 설정 바인딩 클래스 구현

---

## 3. MatchingEngine 확장

### 3.1 MARKET 주문 매칭

- [ ] `placeMarketOrder(order)` 구현
  - [ ] BUY: bestAsk부터 순차 체결, 가격 조건 없음
  - [ ] SELL: bestBid부터 순차 체결, 가격 조건 없음
  - [ ] 잔량 > 0이면 `taker.cancel()` 직접 호출 (orderBook.remove() 없음)
  - [ ] MARKET 주문은 `orderBook.add()` 호출하지 않음
- [ ] `isPriceMatch()` 수정 — `taker.isMarket()`이면 항상 `true` 반환

### 3.2 PlaceResult 반환 타입

구현 시 기본안/대안 중 하나를 선택한다.

| 구분 | 구조 | 선택 기준 |
| -- | ---- | ------- |
| 기본안 | `updatedOrders + trades` | 저장 단순화 우선 |
| 대안  | `taker + filledMakers + cancelled + trades` | 상태 변화 명시성 우선 |

- [ ] `PlaceResult` 클래스 정의 (기본안 또는 대안 선택)
- [ ] `placeLimitOrder()` 반환 타입을 `PlaceResult`로 변경
- [ ] `placeMarketOrder()` 반환 타입 `PlaceResult`로 통일
- [ ] 매칭 루프에서 `remaining == 0`이 된 maker 수집

---

## 4. EngineHandler 확장

- [ ] `PlaceOrder` 커맨드 수신 시 `orderType`으로 분기
  - `LIMIT` → `engine.placeLimitOrder(order)`
  - `MARKET` → `engine.placeMarketOrder(order)`
- [ ] `PlaceResult.updatedOrders` (또는 각 필드) 전부 save
- [ ] trade save (로그 목적)
- [ ] `CancelOrder` 처리는 기존 LIMIT 전용 유지 (MARKET cancel 경로 없음)

---

## 5. OrderBookCache 다종목 대응

- [ ] `OrderBookCache` 내부를 `ConcurrentHashMap<Symbol, OrderBookSnapshot>`으로 변경
- [ ] `OrderBookSnapshot` 완전 불변 구현
  - 겉 객체 불변
  - 내부 컬렉션(호가 리스트 등) `List.copyOf()` 또는 `Collections.unmodifiableList()` 적용
- [ ] engine-thread가 처리 완료 후 해당 symbol 스냅샷만 `put()`으로 교체
- [ ] `OrderBookQueryService`가 symbol을 키로 스냅샷 조회

---

## 6. API 확장

### 엔드포인트

| 메서드      | 경로                    | 변경 내용               |
| -------- | --------------------- | ------------------- |
| `POST`   | `/orders`             | body에 `symbol`, `orderType` 추가 |
| `DELETE` | `/orders/{orderId}`   | 에러 코드 체계 추가         |
| `GET`    | `/orders/{orderId}`   | MARKET 응답 price=null |
| `GET`    | `/orderbook/{symbol}` | 신규 — 심볼별 호가창 조회     |

- [ ] `POST /orders` 요청 body에 `symbol`, `orderType` 필드 추가
- [ ] `orderType == MARKET`이면 `price` 무시
- [ ] 지원하지 않는 `symbol` 요청 시 `400 + UNSUPPORTED_SYMBOL` 반환
- [ ] `GET /orders/{orderId}` 응답에서 MARKET 주문의 `price` 필드 null로 직렬화
- [ ] `GET /orderbook/{symbol}` 엔드포인트 신규 구현 (symbol 파라미터)
- [ ] `DELETE /orders/{orderId}` 에러 코드 체계 구현

| HTTP 상태 | errorCode                 | 원인                        |
| ------- | ------------------------- | ------------------------- |
| `404`   | `ORDER_NOT_FOUND`         | orderId가 존재하지 않음          |
| `409`   | `ORDER_NOT_CANCELLABLE`   | MARKET 주문이라 외부 취소 불가      |
| `409`   | `ORDER_ALREADY_FINALIZED` | 이미 FILLED 또는 CANCELLED 상태 |

---

## 7. 정합성 테스트

### 7.1 MARKET 주문 단위 테스트

- [ ] MARKET BUY — 전량 체결 → `FILLED`, `remaining = 0`
- [ ] MARKET BUY — 유동성 부족 → `PARTIALLY_FILLED` 후 `CANCELLED`
- [ ] MARKET BUY — 호가창 비어 있음 → 즉시 `CANCELLED`
- [ ] MARKET SELL — 전량 체결 → `FILLED`
- [ ] MARKET SELL — 유동성 부족 → `PARTIALLY_FILLED` 후 `CANCELLED`
- [ ] MARKET 주문 `OrderBook.add()` 호출 없음 검증
- [ ] MARKET 주문 외부 cancel 시 `409 + ORDER_NOT_CANCELLABLE` 반환 검증

### 7.2 다종목 독립성 테스트

- [ ] BTC 주문이 ETH OrderBook에 영향을 주지 않음
- [ ] 심볼별 FIFO 보장 — 동일 심볼 내 접수 순서 유지
- [ ] 심볼별 가격 우선 — 유리한 가격이 먼저 체결됨

### 7.3 동시성 테스트

| 케이스     | 목적                              | 방법                                |
| ------- | ------------------------------- | --------------------------------- |
| 스레드 동시성 | 여러 HTTP 스레드가 동시에 submit해도 큐 순서 보장 | `CountDownLatch`로 동시 요청 후 결과 검증   |
| 엔진 독립성  | BTC 엔진 블로킹 중에도 ETH 엔진이 정상 진행    | BTC에 인위적 지연 주입 후 ETH 처리 완료 확인     |

- [ ] 스레드 동시성 테스트 구현
- [ ] 엔진 독립성 테스트 구현

### 7.4 기존 LIMIT 테스트 회귀

- [ ] MVP1 단위 테스트 전체 통과 (변경 없이)
- [ ] LIMIT 가격 우선 검증
- [ ] LIMIT 동일 가격 FIFO 검증
- [ ] LIMIT 부분 체결 / 전량 체결 / 취소

---

## 8. 시뮬레이션 / 불변식 검증

다종목 랜덤 주문 입력 후 아래 항목 모두 0건이어야 한다.

- [ ] 종목 간 상태 간섭 0건
- [ ] MARKET 주문 오동작 0건
- [ ] remaining 음수 0건
- [ ] 상태 전이 위반 0건

---

## 9. 완료 기준 (Definition of Done)

| 기준           | 조건                             |
| ------------ | ------------------------------ |
| 단위 테스트       | 전체 통과                          |
| 다종목 매칭       | BTC / ETH / TEST 동시 주문 정상 처리   |
| MARKET 주문    | 전량체결 / 유동성부족 취소 모두 정상 동작       |
| 심볼 독립성       | 심볼 간 상태 간섭 없음                  |
| 기존 LIMIT 회귀  | MVP1 테스트 전체 통과                 |
| 시뮬레이션        | 다종목 불변식 위반 0건                  |
| 범위 준수        | MVP Phase 2 외 기능 미포함           |

- [ ] 단위 테스트 전체 통과
- [ ] 다종목 주문 정상 매칭
- [ ] MARKET 주문 정상 동작
- [ ] 심볼별 엔진 독립성 보장
- [ ] 기존 LIMIT 테스트 모두 통과
- [ ] 시뮬레이션 테스트 확장 완료
- [ ] MVP Phase 2 범위 외 기능이 포함되지 않음
